extends layout
block inhead
	link(rel="stylesheet", href="css/report.css")
	script(src='js/table_func.js')
	script.
		var lec = !{JSON.stringify(student)};
		var allLec = !{JSON.stringify(avgstudents)};
		
		$(document).ready(function(){
			addToTable('lecture_table', lec, ['Like', 'Difficult', 'Study']);
			addToTable('avg_table', allLec, ['Like', 'Difficult', 'Study']);
			
			var graph_order_N_color = [{name:'Difficult', color: {r:255, g:0, b:0}}, {name:'Like', color: {r:0, g:0, b:0}}, {name:'Study', color: {r:0, g:0, b:255}}];

			addBarChart('lecture_chart_2', lec, graph_order_N_color);
			addBarChart('avg_chart_2', allLec, graph_order_N_color);

			addLineChart('lecture_chart', lec, graph_order_N_color);
			addLineChart('avg_chart', allLec, graph_order_N_color);

			addTableColour();
		});

		function addBarChart(canvas, stats, tag_names)
		{
			var data = {};
			data.labels = [];
			data.datasets = [];

			tag_names.forEach(function(tag_name, index){
				data.datasets.push({
					label : tag_name.name,
					borderWidth : 1,
					borderColor : [],
					backgroundColor : [],
					data : []
				});
				var color;
				if(tag_name.color)
					color = tag_name.color;
				else
					color = randRGB();
				for(var cnt = 0; cnt < Object.keys(stats).length; cnt++)
				{
					data.datasets[index].borderColor.push(RGBA(color, 1));
					data.datasets[index].backgroundColor.push(RGBA(color, 0.2));
				}
			});	


			var cnt = 0;
			var avg = 0;

			Object.keys(stats).forEach(function(lecture){//each section
				var lecVar = stats[lecture];

				data.labels.push(lecture);

				
				tag_names.forEach(function(tag_name, index){
					cnt = 0;
					avg = 0;
				
					Object.keys(lecVar).forEach(function(section){//each section
						var secVar = lecVar[section];
						var tag = secVar[tag_name.name];

						avg += chartFormat(tag.U, tag.U+tag.D);
						cnt++;
					});

					data.datasets[index].data.push(avg/cnt);
				});
			});
			
			var myBarChart = new Chart($('#' + canvas), {
				type: 'bar',
				data: data,
				options: {
					responsive: false,
					animation: false,
					scales: {
						yAxes:[{
							ticks: {
								min : 0,
								max : 100,
								maxTicksLimit: 4,
								stepSize: 25
							}
						}]
					}
				}
			});
		}			
		
		function addLineChart(canvas, stats, tag_names)
		{
			var data = {};
			data.labels = [];
			data.datasets = [];

			tag_names.forEach(function(tag_name, index){
				data.datasets.push({
					label : tag_name.name,
					fill: true,
					lineTension: 0,
					borderCapStyle: 'butt',
					borderDash: [],
					borderDashOffset: 0.0,
					borderJoinStyle: 'miter',
					pointBorderWidth: 1,
					pointHoverRadius: 5,
					pointHoverBorderWidth: 2,
					pointRadius: 0,
					borderWidth : 1,
					borderColor : [],
					backgroundColor : [],
					data : []
				});
				
				var color;
				if(tag_name.color)
					color = tag_name.color;
				else
					color = randRGB();
				for(var cnt = 0; cnt < Object.keys(stats).length; cnt++)
				{
					data.datasets[index].borderColor.push(RGBA(color, 1));
					data.datasets[index].backgroundColor.push(RGBA(color, 0.2));
				}
			});			
			
			var cnt = 0;
			var avg = 0;
			Object.keys(stats).forEach(function(lecture){//each section
				var lecVar = stats[lecture];
				data.labels.push(lecture);

				tag_names.forEach(function(tag_name, index){
					cnt = 0;
					avg = 0;
				
					Object.keys(lecVar).forEach(function(section){//each section
						var secVar = lecVar[section];
						var tag = secVar[tag_name.name];

						avg += chartFormat(tag.U, tag.U+tag.D);
						cnt++;
					});

					data.datasets[index].data.push(avg/cnt);
				});
			});

			var myLineChart = new Chart($('#' + canvas), {
				type: 'line',
				data: data,
				options: {
					responsive: false,
					animation: false,
					scales: {
						yAxes:[{
							ticks: {
								min : 0,
								max : 100,
								maxTicksLimit: 4,
								stepSize: 25
							}
						}]
					}
				}
			});
		}	

		function addToTable(tableid, stats, tag_order)
		{
			Object.keys(stats).forEach(function(lecture){

				$('#' + tableid).append('<tr><th colspan="'+(1+(3*tag_order.length))+'">'+lecture+'</th></tr>');
				_addToTable(tableid, stats[lecture], tag_order)
			});
		}

		function _addToTable(tableid, stats, tag_order)
		{

			addTitletoTable(tableid, tag_order);	

			var avg_tags = [];
			for(var cnt = 0; cnt < tag_order.length; cnt++)
				avg_tags.push({U:0,D:0,UNK:0,length:0, avg:0});

			Object.keys(stats).forEach(function(select){
				var tag_values = [];

				tag_order.forEach(function(tag_name, index){
					tag_values.push(sec_tag_table_entry(stats[select][tag_name]));
					addtoAvg(avg_tags[index], stats[select][tag_name],getPer(stats[select][tag_name]));
				});
				addEntryToTable(tableid, select, tag_values);
			});

			var secLen = Object.keys(stats).length;
			var avg_values = [];
			avg_tags.forEach(function(item){
				avgOut(item, secLen);
				avg_values.push(sec_tag_table_entry(item));
			});

			addEntryToTable(tableid, "AVERAGE", avg_values);
		}

block content
	
	div(class="container-fluid col-sm-10 col-sm-offset-1")
		h2 Course Report
		if (isInstructor)
			h3 Student: #{studentid}

		h4(class="underline") Progress from each Lecture
		table(id="lecture_table", class="table table-striped table-bordered table-condensed")
		canvas(id="lecture_chart", height="300", style="display:inline")
		canvas(id="lecture_chart_2", height="300", style="display:inline")


		h4(class="underline") Average Over Students
		table(id="avg_table", class="table table-striped table-bordered table-condensed")
		canvas(id="avg_chart", height="300", style="display:inline")
		canvas(id="avg_chart_2", height="300", style="display:inline")

	include footer.pug

